<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html"/>
<link rel="import" href="../bower_components/polymerfire/firebase-app.html"/>
<link rel="import" href="../bower_components/polymerfire/firebase-query.html"/>
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="my-icons.html">
<link rel="import" href="db-combo-box.html">

<dom-module id="manage-messages">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }

      paper-input {
        background: #f0f0f0;
      }

      paper-textarea {
        background: #f0f0f0;
      }
    </style>
    <firebase-query id="queryTopicName" path="/users/[[user.uid]]/topicName">
    </firebase-query>
    <firebase-query id="queryUserEmailMeta" path="/users/[[user.uid]]/emailMeta" order-by-child='keyDay'
                    start-at='[[topicKey]]000' end-at='[[topicKey]]999'
                    data="{{emailMetas}}">
    </firebase-query>
    <firebase-query id="queryUserEmailContent" path="/users/[[user.uid]]/emailContent"
                    data="{{userEmailContent}}">
    </firebase-query>
    <firebase-query id="queryTopic" path="/users/[[user.uid]]/topic" data="{{Topic}}">
    </firebase-query>
    <div class="card">
      <div class="circle">Message</div>

      <paper-icon-button raised message="[[message]]"
                         icon="my-icons:chevron-right">Update
      </paper-icon-button>
    </div>
    <div class="card">
      <db-combo-box id="topic"
                    placeholder='Select topic' field='name'
                    dbpath="/users/[[user.uid]]/topic" combolabel="Select Topic"
                    error-message="Please select a Topic" required
                    on-change="topicSelected"></db-combo-box>
      <h2>[[topicName]]</h2>
    </div>
    <div id=validatable class="card" hidden>
      <div class="card">
        <h4 id="addTitle">Add Outgoing Email Message </h4>
        <h3 id="updateTitle" hidden>Update Message</h3>
        <input id="key" type="text" name="key" hidden/>
        <iron-form id="addupdate">
          <form action="/" method="get">
            <paper-input id='day' allowed-pattern="[0-9]" value="{{dayValue}}" on-change="daySelected" required
                         always-float-label label="Which day does this go out on? (example: 3)">
              <input pattern="\d{5}" value="{{value::input}}">
            </paper-input>
            <paper-input id="subject" label="Email Subject:"
                         required always-float-label></paper-input>
            <paper-textarea id="emailBody" label="Email Body:"
                            required always-float-label></paper-textarea>
            <paper-button id="add" on-click="add" type="button">Add</paper-button>
            <paper-button id="update" on-click="update" type="button" hidden>Update</paper-button>
            <paper-button id="clear" on-click="clear" type="button">Clear/Cancel</paper-button>
          </form>
        </iron-form>
      </div>
      <div class="card">
        <template is="dom-repeat" items="[[emailMetas]]" as="message">
          <span>Day [[message.day]]:<strong> [[message.subjectExtract]]</strong></span>
          <span><small><br>[[message.contentExtract]]</small></span>
          <hr>
        </template>
      </div>
    </div>

  </template>

  <script>
    class ManageMessages extends Polymer.Element {
      static get is() {
        return 'manage-messages';
      }

      static get properties() {
        return {
          user: {
            type: Object,
            observer: '_onUser'
          },
          role: {
            type: Object,
            statePath: 'role'
          },
          dayValue: {
            type: Number
          },
          subjectValue: {
            type: String,
            observer: "subjectSelected"
          },
          topicKey: {
            type: String,
            observer: "topicSelected"
          },
          topicName: {
            type: String
          }
        }
      }

      resetForm() {
        this.$.name.value = null;
        this.$.description.value = null;
      }

      update(e) {
        let descrip = this.$.description.value ? this.$.description.value : "";
        let key = this.$.key.value;
        let messageQueryRef = this.$.queryMessages.ref.child(key);
        let postData = {
          name: this.$.name.value,
          description: descrip,
          timestamp: Date.now()
        }
        messageQueryRef.ref.update(postData);
        this.$.name.value = null;
        this.$.description.value = null;

        this.$.key.hidden = true;
        this.$.add.hidden = false;
        this.$.update.hidden = true;
        this.$.updateTitle.hidden = true;
        this.$.addTitle.hidden = false;
        this.$.addupdate.reset()
        return;
      }

      add() {
        let myForm = this.$.addupdate;
        if (myForm.validate()) {
          let emailKey = this.$.queryUserEmailContent.ref.push().key
          let emailMetaObject = this.emailMetaObjectCreate(this.$.topic.value);
          let emailContent = {
            emailBody: this.$.emailBody.value,
            subject: this.$.subject.value,
          };
          emailMetaObject.contentExtract = this.bodyExtract(emailContent);
          emailMetaObject.subject = encodeURIComponent(this.$.subject.value);
          emailMetaObject.subjectExtract = this.emailSubjectExtract(this.$.subject.value);
          emailMetaObject.topicExtract = this.topicExtract(this.$.topic.value);
          emailMetaObject.day = parseInt(this.dayValue);
          emailMetaObject.keyDay = this.topicKey + this.padDayto3();
          let emailMetaUpdates = {};
          emailMetaUpdates["/" + emailKey] = emailMetaObject;
          this.$.queryUserEmailMeta.ref.update(emailMetaUpdates);
          let emailContentUpdates = {};
          emailContentUpdates["/" + emailKey] = emailContent;
          this.$.queryUserEmailContent.ref.update(emailContentUpdates);
          this.$.key.hidden = true;
          this.$.update.hidden = true;
          this.$.add.hidden = false;
          this.$.updateTitle.hidden = true;
          this.$.addTitle.hidden = false;
          this.$.subject.value = null;
          this.$.emailBody.value = null;
          this.dayValue = null;
          this.topicSelected();
        }
        return;
      }

      emailMetaObjectCreate(topicName) {
        let topicKey = this.topicKeyLookup(topicName);
        let topic = this.topicLookup(topicKey);
        let emailMetaObject = {
          topicType: topic.topicType,
          topicName: topicName,
          topicKey: topicKey
        };
        return emailMetaObject;
      }

      padDayto3() {
        let dayNumber = this.dayValue;
        dayNumber = dayNumber.padStart(3, "0");
        return dayNumber;
      }

      topicKeyLookup(topicName) {
        let aTopic;
        let topicNameQueryRef = this.$.queryTopicName.ref.child(topicName);
        topicNameQueryRef.on('value', function (snapshot) {
          aTopic = snapshot.val();
        });
        return aTopic.topicKey;
      }

      topicLookup(topicKey) {
        let aTopic;
        let topicQueryRef = this.$.queryTopic.ref.child(topicKey);
        topicQueryRef.on('value', function (snapshot) {
          aTopic = snapshot.val();
        });
        return aTopic;
      }

      bodyExtract(emailContent) {
        let extract = emailContent.emailBody.replace(/(\r\n|\n|\r)/gm, "");
        extract = extract.substring(0, 100)
        return extract;
      }

      emailSubjectExtract(subjectInput) {
        let subject = subjectInput;
        subject = subject.toUpperCase();
        if (subject.length > 40) {
          subject = subject.substring(0, 40);
        }
        return subject;
      }

      topicExtract(topicName) {
        let date = topicName.substring(0, 10);
        let extractTopic = topicName.substring(21, topicName.length)
        if (extractTopic.startsWith("nex")) {
          extractTopic = extractTopic.substring(3, extractTopic.length);
        }
        return date + " " + extractTopic;
      }

      topicSelected() {
        if (this.$.topic.value) {
          this.$.validatable.hidden = false;
          let aTopicKey = this.$.topic.value;
          this.topicName = aTopicKey.replace(/(~\||\|~)/gm, " - ");
          this.topicKey = aTopicKey.substring(aTopicKey.indexOf("~|") + 2, aTopicKey.length);
        } else {
          this.$.validatable.hidden = true;
          this.topicKey = null;
        }
      }

      clear() {
        this.$.addupdate.reset();
        this.$.name.value = null;
        this.$.description.value = null;
        this.$.add.hidden = false;
        this.$.update.hidden = true;
        this.$.addTitle.hidden = false;
        this.$.updateTitle.hidden = true;
        return;
      }

      display(e) {
        let key = e.currentTarget.message.$key;
        let messageQueryRef = this.$.queryMessages.ref.child(key);
        let aMessage = null;
        messageQueryRef.on('value', function (snapshot) {
          aMessage = snapshot.val();
        });
        this.$.key.value = key;
        this.$.name.value = aMessage.name;
        this.$.description.value = aMessage.description;
        this.$.add.hidden = true;
        this.$.update.hidden = false;
        this.$.addTitle.hidden = true;
        this.$.updateTitle.hidden = false;
      }

      remove(e) {
        let key = e.currentTarget.message.$key;
        this.$.queryMessages.ref.child(key).remove();
      }
    }

    window
      .customElements
      .define(ManageMessages

          .is
        ,
        ManageMessages
      )
    ;
  </script>
</dom-module>
